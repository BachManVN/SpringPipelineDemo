name: '[Guard] Validate Production PR'
run-name: |
  ${{ format('[Guard] Validate Production PR - PR #{0} by {1}', github.event.pull_request.number, github.actor) }}

# CRITICAL: Only allow PRs from 'uat' branch to 'prod' branch
# This ensures production deployments are always the same version tested in UAT
# Configure this as a required status check for 'prod' branch protection

on:
  pull_request:
    branches:
      - prod

jobs:
  validate-source:
    name: Validate PR Source Branch
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Check PR source branch
        run: |
          if [ "${{ github.head_ref }}" != "uat" ]; then
            echo "❌ ERROR: Only PRs from 'uat' branch to 'prod' are allowed"
            echo "   Current: ${{ github.head_ref }} → ${{ github.base_ref }}"
            echo "   Required: uat → prod"
            exit 1
          fi
          
          echo "✅ PR source validated: uat → prod"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify UAT branch points to tag
        run: |
          git fetch origin uat --tags
          UAT_COMMIT=$(git rev-parse origin/uat)
          TAG_AT_COMMIT=$(git describe --tags --exact-match "$UAT_COMMIT" 2>/dev/null || echo "")
          
          if [ -z "$TAG_AT_COMMIT" ]; then
            echo "❌ ERROR: UAT branch HEAD must point to a deployable tag"
            echo "   Commit: $UAT_COMMIT"
            exit 1
          fi
          
          echo "✅ UAT branch points to tag: $TAG_AT_COMMIT"
