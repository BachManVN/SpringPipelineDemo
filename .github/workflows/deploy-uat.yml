name: '[CD] Deploy to UAT and Production'
run-name: |
  ${{ format('[CD] Deploy to UAT and Production - Commit {0} by {1}', github.sha, github.actor) }}

# DEPLOYMENT MODEL: UAT ‚Üí Production pipeline
# - Environments: SIT (separate workflow), UAT, Production
# - Triggered when 'uat' branch is updated (force-pushed to point to a tag)
# - Step 1: Deploy to UAT environment
# - Step 2: Deploy same artifact to Production (requires approval via GitHub environment protection rules)
# - WHY: Ensures production uses exact same artifact tested in UAT
#
# CONFIGURATION:
# - Configure GitHub environments (lowercase): "sit", "uat", "production"
# - Configure GitHub environment "production" with Required reviewers for approval gate
# - Artifact reuse: Production deployment reuses the JAR built for UAT
# - Note: SIT deployments are handled by deploy-sit.yml workflow

on:
  push:
    branches:
      - uat

env:
  JAVA_VERSION: '17'
  AZURE_WEBAPP_NAME_UAT: ${{ vars.AZURE_WEBAPP_NAME_UAT || 'springboot-azure-demo-uat' }}
  AZURE_RESOURCE_GROUP_UAT: ${{ vars.AZURE_RESOURCE_GROUP_UAT || 'rg-springboot-demo-uat' }}
  AZURE_WEBAPP_NAME_PROD: ${{ vars.AZURE_WEBAPP_NAME_PROD || 'springboot-azure-demo-prod' }}
  AZURE_RESOURCE_GROUP_PROD: ${{ vars.AZURE_RESOURCE_GROUP_PROD || 'rg-springboot-demo-prod' }}

jobs:
  deploy-uat:
    name: Deploy to UAT
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Azure authentication
    environment:
      name: uat
      url: https://${{ env.AZURE_WEBAPP_NAME_UAT }}.azurewebsites.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag verification

      - name: Verify tag at HEAD
        id: verify-tag
        run: |
          TAG_AT_HEAD=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "")
          
          if [ -z "$TAG_AT_HEAD" ]; then
            echo "‚ùå ERROR: UAT branch must point to a deployable tag"
            echo "   To deploy: git checkout <TAG> && git checkout -B uat && git push origin uat --force"
            exit 1
          fi
          
          echo "‚úÖ Deploying tag: $TAG_AT_HEAD"
          echo "tag=$TAG_AT_HEAD" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Maven tests
        run: mvn test

      - name: Build application
        run: |
          echo "üî® Building application from tag ${{ steps.verify-tag.outputs.tag }}..."
          mvn clean package -DskipTests

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ] || ! cp "$JAR_FILE" deploy/app.jar; then
            echo "‚ùå ERROR: Failed to prepare deployment package"
            exit 1
          fi
          
          echo "‚úÖ Deployment package prepared: deploy/app.jar"

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-jar
          path: deploy/app.jar
          retention-days: 1
          compression-level: 0  # JAR is already compressed

      - name: Azure Login (UAT)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_UAT }}

      - name: Get App Service hostname (UAT)
        id: app-service-uat
        run: |
          APP_NAME="${{ env.AZURE_WEBAPP_NAME_UAT }}"
          RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP_UAT }}"
          
          if ! az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            echo "‚ùå ERROR: App Service '$APP_NAME' not found"
            exit 1
          fi
          
          HOSTNAME=$(az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query "defaultHostName" -o tsv 2>/dev/null || echo "$APP_NAME.azurewebsites.net")
          echo "hostname=$HOSTNAME" >> $GITHUB_OUTPUT

      - name: Deploy to Azure App Service (UAT)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_UAT }}
          package: deploy/app.jar
          slot-name: ''  # Deploy directly to UAT slot
          startup-command: 'java -jar /home/site/wwwroot/app.jar --spring.profiles.active=uat'

      - name: Verify UAT deployment health
        run: |
          HOSTNAME="${{ steps.app-service-uat.outputs.hostname }}"
          HEALTH_URL="https://${HOSTNAME}/actuator/health"
          
          sleep 15
          for i in $(seq 1 15); do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")
            
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ UAT deployment verified - Tag: ${{ steps.verify-tag.outputs.tag }}"
              exit 0
            fi
            
            [ $i -lt 15 ] && sleep 8
          done
          
          echo "‚ùå UAT health check failed after 15 attempts"
          exit 1

  deploy-prod:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-uat
    if: success()
    permissions:
      contents: read
      id-token: write
    environment:
      name: production
      url: https://${{ env.AZURE_WEBAPP_NAME_PROD }}.azurewebsites.net

    steps:
      - name: Checkout code (for tag verification)
        uses: actions/checkout@v4
        with:
          ref: uat
          fetch-depth: 0

      - name: Verify tag
        id: verify-tag
        run: |
          TAG_AT_HEAD=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "")
          if [ -z "$TAG_AT_HEAD" ]; then
            echo "‚ùå ERROR: UAT branch must point to a deployable tag"
            exit 1
          fi
          echo "‚úÖ Deploying to Production: $TAG_AT_HEAD"
          echo "tag=$TAG_AT_HEAD" >> $GITHUB_OUTPUT

      - name: Download deployment artifact
        uses: actions/download-artifact@v4
        with:
          name: deployment-jar
          path: deploy/

      - name: Azure Login (Production)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_PROD }}

      - name: Check for staging slot
        id: check-slot
        run: |
          APP_NAME="${{ env.AZURE_WEBAPP_NAME_PROD }}"
          RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP_PROD }}"
          
          STAGING_SLOT=$(az webapp deployment slot list \
            --resource-group "$RESOURCE_GROUP" \
            --name "$APP_NAME" \
            --query "[?name=='staging'].name" -o tsv 2>/dev/null || echo "")
          
          if [ -n "$STAGING_SLOT" ]; then
            echo "‚úÖ Staging slot detected - using blue-green deployment for Production"
            echo "use_slot=true" >> $GITHUB_OUTPUT
            echo "slot_name=staging" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è  No staging slot - direct deployment to Production"
            echo "use_slot=false" >> $GITHUB_OUTPUT
            echo "slot_name=" >> $GITHUB_OUTPUT
          fi

      - name: Get App Service hostname (Production)
        id: app-service-prod
        run: |
          APP_NAME="${{ env.AZURE_WEBAPP_NAME_PROD }}"
          RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP_PROD }}"
          
          if ! az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            echo "‚ùå ERROR: App Service not found"
            exit 1
          fi
          
          PROD_HOSTNAME=$(az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query "defaultHostName" -o tsv 2>/dev/null || echo "$APP_NAME.azurewebsites.net")
          echo "hostname=$PROD_HOSTNAME" >> $GITHUB_OUTPUT

      - name: Deploy to Production staging slot
        if: steps.check-slot.outputs.use_slot == 'true'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_PROD }}
          package: deploy/app.jar
          slot-name: ${{ steps.check-slot.outputs.slot_name }}
          startup-command: 'java -jar /home/site/wwwroot/app.jar --spring.profiles.active=prod'

      - name: Deploy to Production (direct)
        if: steps.check-slot.outputs.use_slot != 'true'
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_PROD }}
          package: deploy/app.jar
          slot-name: ''
          startup-command: 'java -jar /home/site/wwwroot/app.jar --spring.profiles.active=prod'

      - name: Verify staging slot deployment health
        if: steps.check-slot.outputs.use_slot == 'true'
        run: |
          APP_NAME="${{ env.AZURE_WEBAPP_NAME_PROD }}"
          RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP_PROD }}"
          SLOT_NAME="${{ steps.check-slot.outputs.slot_name }}"
          
          HOSTNAME=$(az webapp deployment slot show \
            --name "$APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --slot "$SLOT_NAME" \
            --query "defaultHostName" -o tsv 2>/dev/null || echo "")
          
          HEALTH_URL="https://${HOSTNAME}/actuator/health"
          sleep 15
          
          for i in $(seq 1 15); do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Production staging slot deployment verified"
              exit 0
            fi
            [ $i -lt 15 ] && sleep 8
          done
          
          echo "‚ùå Production staging slot health check failed"
          exit 1

      - name: Swap staging slot to Production
        if: steps.check-slot.outputs.use_slot == 'true'
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az webapp deployment slot swap \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP_PROD }} \
              --name ${{ env.AZURE_WEBAPP_NAME_PROD }} \
              --slot staging \
              --target-slot production

      - name: Verify Production deployment
        run: |
          HEALTH_URL="https://${{ steps.app-service-prod.outputs.hostname }}/actuator/health"
          sleep 15
          
          for i in $(seq 1 15); do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Production deployment verified - Tag: ${{ steps.verify-tag.outputs.tag }}"
              echo "   Artifact: Reused from UAT deployment"
              exit 0
            fi
            [ $i -lt 15 ] && sleep 8
          done
          
          echo "‚ùå Production health check failed"
          exit 1

      - name: Post deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ PRODUCTION deployment completed"
            echo "   Tag: ${{ steps.verify-tag.outputs.tag }}"
            echo "   Artifact: Reused from UAT deployment"
          else
            echo "‚ùå PRODUCTION deployment failed"
          fi
