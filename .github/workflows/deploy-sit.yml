name: '[CD] Deploy to SIT'
run-name: |
  ${{ format('[CD] Deploy to SIT - Commit {0} by {1}', github.sha, github.actor) }}

# DEPLOYMENT MODEL: Tag-based deployment
# - Triggered when 'sit' branch is updated (force-pushed to point to a tag)
# - Verifies 'sit' branch points to a deployable tag
# - Simulates deployment to SIT environment (placeholder for actual deployment)
# - SIT branch is a deployment pointer, not a code source

on:
  push:
    branches:
      - sit

env:
  JAVA_VERSION: '17'

jobs:
  deploy-sit:
    name: Deploy to SIT
    runs-on: ubuntu-latest
    permissions:
      contents: read
    environment:
      name: sit

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag verification

      - name: Verify deployment source
        id: verify-source
        run: |
          COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          
          # Check if HEAD is a tag (preferred, but not required for SIT)
          TAG_AT_HEAD=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "")
          
          if [ -n "$TAG_AT_HEAD" ]; then
            echo "‚úÖ Deploying tag: $TAG_AT_HEAD"
            echo "tag=$TAG_AT_HEAD" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "‚ÑπÔ∏è  Deploying commit: $COMMIT_SHORT (not a tag)"
            echo "tag=" >> $GITHUB_OUTPUT
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi
          
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Maven tests
        run: mvn test

      - name: Build application
        run: |
          if [ "${{ steps.verify-source.outputs.is_tag }}" = "true" ]; then
            echo "üî® Building application from tag ${{ steps.verify-source.outputs.tag }}..."
          else
            echo "üî® Building application from commit ${{ steps.verify-source.outputs.commit_short }}..."
          fi
          mvn clean package -DskipTests

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ] || ! cp "$JAR_FILE" deploy/app.jar; then
            echo "‚ùå ERROR: Failed to prepare deployment package"
            exit 1
          fi
          
          echo "‚úÖ Deployment package prepared: deploy/app.jar"
          echo "üì¶ JAR size: $(du -h deploy/app.jar | cut -f1)"

      - name: Simulate deployment to SIT
        run: |
          echo "üöÄ [PLACEHOLDER] Deploying to SIT environment..."
          if [ "${{ steps.verify-source.outputs.is_tag }}" = "true" ]; then
            echo "   Tag: ${{ steps.verify-source.outputs.tag }}"
          else
            echo "   Commit: ${{ steps.verify-source.outputs.commit_short }}"
          fi
          echo "   Full Commit: ${{ steps.verify-source.outputs.commit }}"
          echo "   Environment: SIT"
          echo "   Package: deploy/app.jar"
          echo "   Profile: sit"
          echo ""
          echo "‚úÖ [PLACEHOLDER] Deployment to SIT completed successfully"
          echo "   In a real scenario, this would deploy to Azure App Service or similar platform"

      - name: Simulate health check
        run: |
          echo "üîç [PLACEHOLDER] Verifying SIT deployment health..."
          sleep 2
          echo "‚úÖ [PLACEHOLDER] Health check passed"
          echo "   Endpoint: /actuator/health"
          echo "   Status: UP"
