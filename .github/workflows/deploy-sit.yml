name: '[CD] Deploy to SIT'
run-name: |
  ${{ format('[CD] Deploy to SIT - Commit {0} by {1}', github.sha, github.actor) }}

# DEPLOYMENT MODEL: Tag-based deployment
# - Triggered when 'sit' branch is updated (force-pushed to point to a tag)
# - Verifies 'sit' branch points to a deployable tag
# - Deploys the tagged version to SIT environment
# - SIT branch is a deployment pointer, not a code source

on:
  push:
    branches:
      - sit

env:
  JAVA_VERSION: '17'
  AZURE_WEBAPP_NAME: ${{ vars.AZURE_WEBAPP_NAME_SIT || 'springboot-azure-demo-sit' }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP_SIT || 'rg-springboot-demo-sit' }}
  AZURE_REGION: ${{ vars.AZURE_REGION || 'southeastasia' }}

jobs:
  deploy-sit:
    name: Deploy to SIT
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for Azure authentication
    environment:
      name: sit
      url: https://${{ env.AZURE_WEBAPP_NAME }}.azurewebsites.net

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag verification

      - name: Verify tag at HEAD
        id: verify-tag
        run: |
          TAG_AT_HEAD=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "")
          
          if [ -z "$TAG_AT_HEAD" ]; then
            echo "‚ùå ERROR: SIT branch must point to a deployable tag"
            echo "   To deploy: git checkout <TAG> && git checkout -B sit && git push origin sit --force"
            exit 1
          fi
          
          echo "‚úÖ Deploying tag: $TAG_AT_HEAD"
          echo "tag=$TAG_AT_HEAD" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Maven tests
        run: mvn test

      - name: Build application
        run: |
          echo "üî® Building application from tag ${{ steps.verify-tag.outputs.tag }}..."
          mvn clean package -DskipTests

      - name: Prepare deployment package
        run: |
          mkdir -p deploy
          JAR_FILE=$(find target -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" | head -1)
          
          if [ -z "$JAR_FILE" ] || ! cp "$JAR_FILE" deploy/app.jar; then
            echo "‚ùå ERROR: Failed to prepare deployment package"
            exit 1
          fi

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_SIT }}

      - name: Get App Service hostname
        id: app-service
        run: |
          APP_NAME="${{ env.AZURE_WEBAPP_NAME }}"
          RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP }}"
          
          if ! az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" >/dev/null 2>&1; then
            echo "‚ùå ERROR: App Service '$APP_NAME' not found"
            exit 1
          fi
          
          HOSTNAME=$(az webapp show --name "$APP_NAME" --resource-group "$RESOURCE_GROUP" --query "defaultHostName" -o tsv 2>/dev/null || echo "$APP_NAME.azurewebsites.net")
          echo "hostname=$HOSTNAME" >> $GITHUB_OUTPUT

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: deploy/app.jar
          slot-name: ''  # Deploy directly to production slot (no deployment slots for SIT)
          startup-command: 'java -jar /home/site/wwwroot/app.jar --spring.profiles.active=sit'

      - name: Verify deployment health
        run: |
          HOSTNAME="${{ steps.app-service.outputs.hostname }}"
          HEALTH_URL="https://${HOSTNAME}/actuator/health"
          
          sleep 15
          for i in $(seq 1 15); do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$HEALTH_URL" 2>/dev/null || echo "000")
            
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Deployment verified - Tag: ${{ steps.verify-tag.outputs.tag }}"
              exit 0
            fi
            
            [ $i -lt 15 ] && sleep 8
          done
          
          echo "‚ùå Health check failed after 15 attempts"
          exit 1
